import{a as p}from"./index-DT9TBuYH.js";import{_ as Q}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as b,y as B,h as W,M as l,c as X,a as c,b as n,w as a,d as i,o as _,f as d,t as I,m as y}from"./index-DNqqV_T_.js";const Y={class:"admin-registration"},Z={class:"invite-code"},ee={__name:"Registration",setup(te){const V=b(!1),C=b(!1),k=b([]),g=b(!1),r=B({registration_enabled:!0,invite_required:!1}),s=B({maxUses:1,expiresIn:7,count:1}),M=[{colKey:"code",title:"邀请码",width:200,cell:"code"},{colKey:"status",title:"状态",width:100,cell:"status"},{colKey:"usage",title:"使用情况",width:200,cell:"usage"},{colKey:"creator_name",title:"创建者",width:120},{colKey:"created_at",title:"创建时间",width:180,cell:"created_at"},{colKey:"expires_at",title:"过期时间",width:180,cell:"expires_at"},{colKey:"operation",title:"操作",width:100,fixed:"right",cell:"operation"}];W(()=>{S(),w()});async function S(){var t,e;try{const m=await p.getSystemSettings();if(m.data.success){const u=m.data.data;r.registration_enabled=((t=u.registration_enabled)==null?void 0:t.value)==="true",r.invite_required=((e=u.invite_required)==null?void 0:e.value)==="true"}}catch(m){console.error("加载设置失败:",m),l.error("加载设置失败")}}async function N(){C.value=!0;try{(await p.updateSystemSettings({registration_enabled:r.registration_enabled?"true":"false",invite_required:r.invite_required?"true":"false"})).data.success&&l.success("设置保存成功")}catch(t){console.error("保存设置失败:",t),l.error("保存设置失败")}finally{C.value=!1}}async function w(){V.value=!0;try{const t=await p.getInviteCodes();t.data.success&&(k.value=t.data.data)}catch(t){console.error("加载邀请码失败:",t),l.error("加载邀请码失败")}finally{V.value=!1}}function T(){s.maxUses=1,s.expiresIn=7,s.count=1,g.value=!0}async function z(){try{const t=[];for(let e=0;e<s.count;e++)t.push(p.generateInviteCode({maxUses:s.maxUses,expiresIn:s.expiresIn||null}));await Promise.all(t),l.success(`成功生成${s.count}个邀请码`),g.value=!1,w()}catch(t){console.error("生成邀请码失败:",t),l.error("生成邀请码失败")}}async function P(t){try{(await p.deleteInviteCode(t)).data.success&&(l.success("删除成功"),w())}catch(e){console.error("删除邀请码失败:",e),l.error("删除邀请码失败")}}function E(t){navigator.clipboard.writeText(t).then(()=>{l.success("邀请码已复制到剪贴板")}).catch(()=>{l.error("复制失败")})}function F(t){return t.expires_at?new Date(t.expires_at)<new Date:!1}function L(t){return t.used_count>=t.max_uses}function q(t){return Math.round(t.used_count/t.max_uses*100)}function R(t){return`${t.used_count} / ${t.max_uses}`}function A(t){const e=q(t);return e>=100?"success":e>=75?"warning":"primary"}function K(t){return t?new Date(t).toLocaleString("zh-CN"):"-"}return(t,e)=>{const m=i("t-switch"),u=i("t-form-item"),v=i("t-icon"),f=i("t-button"),D=i("t-space"),h=i("t-form"),$=i("t-card"),x=i("t-tag"),G=i("t-progress"),j=i("t-popconfirm"),H=i("t-table"),U=i("t-input-number"),J=i("t-dialog");return _(),X("div",Y,[e[19]||(e[19]=c("div",{class:"page-header"},[c("h3",null,"注册管理")],-1)),n($,{title:"注册设置",class:"settings-card"},{default:a(()=>[n(h,{data:r,onSubmit:N,"label-width":"150px"},{default:a(()=>[n(u,{label:"允许用户注册"},{default:a(()=>[n(m,{modelValue:r.registration_enabled,"onUpdate:modelValue":e[0]||(e[0]=o=>r.registration_enabled=o)},null,8,["modelValue"]),e[6]||(e[6]=c("div",{class:"form-tip"},"关闭后，新用户无法注册账号",-1))]),_:1}),n(u,{label:"需要邀请码"},{default:a(()=>[n(m,{modelValue:r.invite_required,"onUpdate:modelValue":e[1]||(e[1]=o=>r.invite_required=o),disabled:!r.registration_enabled},null,8,["modelValue","disabled"]),e[7]||(e[7]=c("div",{class:"form-tip"},"开启后，注册时必须提供有效的邀请码",-1))]),_:1}),n(u,null,{default:a(()=>[n(D,null,{default:a(()=>[n(f,{theme:"primary",type:"submit",loading:C.value},{icon:a(()=>[n(v,{name:"check"})]),default:a(()=>[e[8]||(e[8]=d(" 保存设置 ",-1))]),_:1},8,["loading"]),n(f,{onClick:S},{icon:a(()=>[n(v,{name:"refresh"})]),default:a(()=>[e[9]||(e[9]=d(" 重置 ",-1))]),_:1})]),_:1})]),_:1})]),_:1},8,["data"])]),_:1}),n($,{title:"邀请码管理",class:"invite-card"},{actions:a(()=>[n(f,{theme:"primary",onClick:T},{icon:a(()=>[n(v,{name:"add"})]),default:a(()=>[e[10]||(e[10]=d(" 生成邀请码 ",-1))]),_:1})]),default:a(()=>[n(H,{data:k.value,columns:M,loading:V.value,"row-key":"id",bordered:"",stripe:""},{code:a(({row:o})=>[n(D,{align:"center"},{default:a(()=>[c("code",Z,I(o.code),1),n(f,{size:"small",variant:"text",onClick:O=>E(o.code)},{default:a(()=>[n(v,{name:"file-copy"})]),_:1},8,["onClick"])]),_:2},1024)]),status:a(({row:o})=>[o.is_active?F(o)?(_(),y(x,{key:1,theme:"warning"},{default:a(()=>[...e[12]||(e[12]=[d("已过期",-1)])]),_:1})):L(o)?(_(),y(x,{key:2,theme:"default"},{default:a(()=>[...e[13]||(e[13]=[d("已用完",-1)])]),_:1})):(_(),y(x,{key:3,theme:"success"},{default:a(()=>[...e[14]||(e[14]=[d("有效",-1)])]),_:1})):(_(),y(x,{key:0,theme:"danger"},{default:a(()=>[...e[11]||(e[11]=[d("已禁用",-1)])]),_:1}))]),usage:a(({row:o})=>[n(G,{percentage:q(o),label:R(o),theme:A(o)},null,8,["percentage","label","theme"])]),created_at:a(({row:o})=>[d(I(K(o.created_at)),1)]),expires_at:a(({row:o})=>[d(I(o.expires_at?K(o.expires_at):"永不过期"),1)]),operation:a(({row:o})=>[n(j,{content:"确定要删除这个邀请码吗？",onConfirm:O=>P(o.id)},{default:a(()=>[n(f,{size:"small",variant:"text",theme:"danger"},{default:a(()=>[...e[15]||(e[15]=[d(" 删除 ",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1},8,["data","loading"])]),_:1}),n(J,{visible:g.value,"onUpdate:visible":e[5]||(e[5]=o=>g.value=o),header:"生成邀请码",width:"500px",onConfirm:z},{default:a(()=>[n(h,{data:s,"label-width":"120px"},{default:a(()=>[n(u,{label:"最大使用次数",name:"maxUses"},{default:a(()=>[n(U,{modelValue:s.maxUses,"onUpdate:modelValue":e[2]||(e[2]=o=>s.maxUses=o),min:1,max:1e3},null,8,["modelValue"]),e[16]||(e[16]=c("div",{class:"form-tip"},"每个邀请码最多可以被使用的次数",-1))]),_:1}),n(u,{label:"有效期（天）",name:"expiresIn"},{default:a(()=>[n(U,{modelValue:s.expiresIn,"onUpdate:modelValue":e[3]||(e[3]=o=>s.expiresIn=o),min:0,max:365,placeholder:"0表示永不过期"},null,8,["modelValue"]),e[17]||(e[17]=c("div",{class:"form-tip"},"邀请码的有效天数，0表示永不过期",-1))]),_:1}),n(u,{label:"生成数量",name:"count"},{default:a(()=>[n(U,{modelValue:s.count,"onUpdate:modelValue":e[4]||(e[4]=o=>s.count=o),min:1,max:50},null,8,["modelValue"]),e[18]||(e[18]=c("div",{class:"form-tip"},"一次性生成多个邀请码",-1))]),_:1})]),_:1},8,["data"])]),_:1},8,["visible"])])}}},se=Q(ee,[["__scopeId","data-v-92998ef2"]]);export{se as default};
