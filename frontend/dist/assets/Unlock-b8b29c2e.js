import{u as A,p as K,b as j,r as t,o as D,d as u,e as b,f as M,g as r,h as o,t as w,j as U,q as E,w as d,i as F,m as G,M as y,l as C,s as J}from"./index-82da048e.js";import{a as m}from"./index-e7daf545.js";import{_ as L}from"./_plugin-vue_export-helper-c27b6911.js";const O={class:"unlock-container"},Q={class:"unlock-icon"},W={class:"unlock-title"},X={key:0,class:"hint-box"},Y={class:"password-wrapper"},Z={class:"password-hint"},ss={class:"unlock-footer"},es={__name:"Unlock",setup(as){const T=A(),{t:c}=K(),z=j(),i=t(!1),h=t(!0),v=t(""),_=t(!1),f=t(null),l=t({password:""}),p=t(!1),e=t({password:"",hint:""}),I={password:[{required:!0,message:c("auth.enterPassword")},{min:6,message:c("auth.passwordTooShort")}]},P=()=>{J(()=>{var s;f.value&&((s=f.value.$el.querySelector("input"))==null||s.focus())})},B=()=>{_.value=!0,setTimeout(()=>{_.value=!1},500)},N=async()=>{try{const s=await m.checkMasterPassword();if(h.value=s.data.data.hasPassword,!h.value)p.value=!0;else{const a=await m.getPasswordHint();v.value=a.data.data.hint,P()}}catch(s){console.error("Check master password failed:",s)}},k=async()=>{if(l.value.password){i.value=!0;try{const s=await m.unlock({password:l.value.password});s.data.success&&(z.unlock(s.data.data.sessionToken),y.success(c("auth.unlockSuccess")),T.push("/"))}catch(s){console.error("Unlock failed:",s),B(),l.value.password="",P()}finally{i.value=!1}}},q=()=>{p.value=!0},H=async()=>{if(!e.value.password||e.value.password.length<6){y.warning(c("auth.passwordTooShort"));return}try{(await m.setMasterPassword(e.value)).data.success&&(y.success(c("common.success")),h.value=!0,p.value=!1,v.value=e.value.hint,l.value.password=e.value.password,k())}catch(s){console.error("Set password failed:",s)}};return D(()=>{N()}),(s,a)=>{const V=u("t-icon"),g=u("t-input"),S=u("t-button"),$=u("t-form-item"),R=u("t-form"),x=u("t-dialog");return b(),M("div",O,[r("div",{class:G(["unlock-box",{shake:_.value}])},[r("div",Q,[o(V,{name:"lock-on"})]),r("h1",W,w(s.$t("auth.unlock")),1),v.value?(b(),M("div",X,[o(V,{name:"info-circle",size:"14px"}),r("span",null,w(v.value),1)])):U("",!0),r("div",Y,[o(g,{ref_key:"passwordInput",ref:f,modelValue:l.value.password,"onUpdate:modelValue":a[0]||(a[0]=n=>l.value.password=n),type:"password",size:"large",placeholder:s.$t("auth.enterPassword"),onKeyup:E(k,["enter"]),disabled:i.value},null,8,["modelValue","placeholder","disabled"]),r("div",Z,w(s.$t("auth.enterMasterPassword")),1)]),o(S,{theme:"primary",size:"large",block:"",loading:i.value,disabled:!l.value.password,onClick:k,class:"unlock-button"},{default:d(()=>[C(w(i.value?s.$t("auth.unlocking"):s.$t("auth.unlock")),1)]),_:1},8,["loading","disabled"]),r("div",ss,[h.value?U("",!0):(b(),F(S,{key:0,variant:"text",size:"small",onClick:q},{default:d(()=>[C(w(s.$t("auth.setMasterPassword")),1)]),_:1}))])],2),o(x,{visible:p.value,"onUpdate:visible":a[3]||(a[3]=n=>p.value=n),header:s.$t("auth.setMasterPassword"),width:"500px",onConfirm:H},{default:d(()=>[o(R,{data:e.value,rules:I},{default:d(()=>[o($,{label:s.$t("auth.password"),name:"password"},{default:d(()=>[o(g,{modelValue:e.value.password,"onUpdate:modelValue":a[1]||(a[1]=n=>e.value.password=n),type:"password"},null,8,["modelValue"])]),_:1},8,["label"]),o($,{label:s.$t("auth.passwordHint"),name:"hint"},{default:d(()=>[o(g,{modelValue:e.value.hint,"onUpdate:modelValue":a[2]||(a[2]=n=>e.value.hint=n),placeholder:s.$t("auth.passwordHint")+"（可选）"},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["data"])]),_:1},8,["visible","header"])])}}},ns=L(es,[["__scopeId","data-v-72705969"]]);export{ns as default};
