import{d as w}from"./index-e7daf545.js";import{_ as re}from"./_plugin-vue_export-helper-c27b6911.js";import{r as p,o as E,a as ue,c as M,z as ce,d as u,e as U,f as de,h as a,w as t,M as d,g as b,l as f,n as R,t as V,i as N,j as T}from"./index-82da048e.js";const me={class:"api-keys app-container"},pe={class:"page-header"},ve={class:"filters"},_e={style:{"margin-top":"8px"}},fe={__name:"ApiKeys",setup(ye){const C=p([]),g=p(!1),z=p(""),o=p({id:null,name:"",permissions:"read",expiresIn:""}),L=p(null),y=p(""),c=p({keyword:"",permissions:"",status:""}),m=p({current:1,pageSize:10,total:0}),K=p(!1),h=p(!1),_=p(window.innerWidth<=768),$={name:[{required:!0,message:"请输入密钥名称",type:"error"},{min:2,message:"名称至少2个字符",type:"warning"}]},B=()=>{_.value=window.innerWidth<=768};E(()=>{window.addEventListener("resize",B)}),ue(()=>{window.removeEventListener("resize",B)});const q=[{colKey:"name",title:"名称"},{colKey:"key_prefix",title:"前缀"},{colKey:"permissions",title:"权限",cell:"permissions"},{colKey:"is_active",title:"启用",cell:"is_active",width:120},{colKey:"expires_at",title:"到期时间",width:180},{colKey:"last_used_at",title:"最后使用",width:180},{colKey:"operation",title:"操作",width:200}],I=async()=>{var l,e;K.value=!0;try{const s=await w.list();C.value=s.data.data||[],m.value.total=S.value.length}catch(s){console.error("加载 API 密钥失败:",s),d.error(((e=(l=s.response)==null?void 0:l.data)==null?void 0:e.message)||"加载 API 密钥失败")}finally{K.value=!1}},S=M(()=>{const l=(c.value.keyword||"").toLowerCase();return(C.value||[]).filter(e=>{const s=!l||String(e.name||"").toLowerCase().includes(l)||String(e.key_prefix||"").toLowerCase().includes(l),i=!c.value.permissions||e.permissions===c.value.permissions,v=c.value.status===""||String(e.is_active)===String(c.value.status);return s&&i&&v})}),W=M(()=>{const l=(m.value.current-1)*m.value.pageSize;return S.value.slice(l,l+m.value.pageSize)});ce(S,l=>{m.value.total=l.length,(m.value.current-1)*m.value.pageSize>=l.length&&(m.value.current=1)});const j=l=>{const{current:e,pageSize:s}=l;m.value.current=e,m.value.pageSize=s},D=()=>{c.value={keyword:"",permissions:"",status:""}},F=()=>{z.value="新建密钥",o.value={id:null,name:"",permissions:"read",expiresIn:""},y.value="",g.value=!0},G=l=>{z.value="编辑密钥",o.value={id:l.id,name:l.name,permissions:l.permissions,expiresIn:""},y.value="",g.value=!0},H=async()=>{var e,s,i,v;if(await((e=L.value)==null?void 0:e.validate())){h.value=!0;try{if(o.value.id)await w.update(o.value.id,{name:o.value.name,permissions:o.value.permissions}),d.success("更新成功"),g.value=!1;else{const r=await w.create({name:o.value.name,permissions:o.value.permissions,expiresIn:o.value.expiresIn});y.value=((s=r.data.data)==null?void 0:s.apiKey)||"",d.success("创建成功，请立即保存密钥")}await I()}catch(r){console.error("提交失败:",r),d.error(((v=(i=r.response)==null?void 0:i.data)==null?void 0:v.message)||"操作失败，请重试")}finally{h.value=!1}}},J=async(l,e)=>{var s,i;try{await w.update(l.id,{isActive:e}),l.is_active=e?1:0,d.success(e?"已启用":"已禁用")}catch(v){console.error("切换状态失败:",v),d.error(((i=(s=v.response)==null?void 0:s.data)==null?void 0:i.message)||"操作失败"),l.is_active=e?0:1}},O=async l=>{var e,s;try{await w.delete(l.id),d.success("删除成功"),await I()}catch(i){console.error("删除失败:",i),d.error(((s=(e=i.response)==null?void 0:e.data)==null?void 0:s.message)||"删除失败")}},Q=async l=>{try{await navigator.clipboard.writeText(l.key_prefix||""),d.success("前缀已复制到剪贴板")}catch(e){console.error("复制失败:",e),d.error("复制失败，请手动复制")}},X=async()=>{try{await navigator.clipboard.writeText(y.value),d.success("完整密钥已复制到剪贴板")}catch(l){console.error("复制失败:",l),d.error("复制失败，请手动复制")}};return E(()=>{I()}),(l,e)=>{const s=u("t-icon"),i=u("t-button"),v=u("t-input"),r=u("t-option"),x=u("t-select"),A=u("t-space"),Y=u("t-tag"),Z=u("t-switch"),ee=u("t-popconfirm"),ae=u("t-table"),te=u("t-loading"),le=u("t-card"),P=u("t-form-item"),se=u("t-textarea"),ne=u("t-alert"),oe=u("t-form"),ie=u("t-dialog");return U(),de("div",me,[a(le,{class:"app-card"},{default:t(()=>[b("div",pe,[e[8]||(e[8]=b("h1",null,"API 密钥管理",-1)),a(i,{theme:"primary",onClick:F},{icon:t(()=>[a(s,{name:"add"})]),default:t(()=>[e[7]||(e[7]=f(" 新建密钥 ",-1))]),_:1})]),b("div",ve,[a(A,{direction:"vertical",style:{width:"100%"}},{default:t(()=>[a(A,{"break-line":_.value},{default:t(()=>[a(v,{modelValue:c.value.keyword,"onUpdate:modelValue":e[0]||(e[0]=n=>c.value.keyword=n),placeholder:"搜索名称或前缀",clearable:"",style:R({width:_.value?"100%":"220px"})},{"prefix-icon":t(()=>[a(s,{name:"search"})]),_:1},8,["modelValue","style"]),a(x,{modelValue:c.value.permissions,"onUpdate:modelValue":e[1]||(e[1]=n=>c.value.permissions=n),placeholder:"权限",clearable:"",style:R({width:_.value?"100%":"140px"})},{default:t(()=>[a(r,{value:"",label:"全部"}),a(r,{value:"read",label:"只读"}),a(r,{value:"write",label:"读写"})]),_:1},8,["modelValue","style"]),a(x,{modelValue:c.value.status,"onUpdate:modelValue":e[2]||(e[2]=n=>c.value.status=n),placeholder:"状态",clearable:"",style:R({width:_.value?"100%":"140px"})},{default:t(()=>[a(r,{value:"",label:"全部"}),a(r,{value:"1",label:"启用"}),a(r,{value:"0",label:"禁用"})]),_:1},8,["modelValue","style"]),a(i,{variant:"outline",onClick:D},{icon:t(()=>[a(s,{name:"refresh"})]),default:t(()=>[e[9]||(e[9]=f(" 重置 ",-1))]),_:1})]),_:1},8,["break-line"])]),_:1})]),a(te,{loading:K.value,size:"large"},{default:t(()=>[a(ae,{data:W.value,columns:q,"row-key":"id",stripe:"",hover:"",pagination:m.value,onPageChange:j,empty:C.value.length===0?"暂无 API 密钥，点击上方按钮新建":"没有符合条件的数据"},{permissions:t(({row:n})=>[a(Y,{theme:"primary",variant:"light-outline"},{default:t(()=>[f(V(n.permissions),1)]),_:2},1024)]),is_active:t(({row:n})=>[a(Z,{value:n.is_active===1,onChange:k=>J(n,k)},null,8,["value","onChange"])]),operation:t(({row:n})=>[a(A,{size:_.value?"small":"medium"},{default:t(()=>[a(i,{size:"small",onClick:k=>G(n)},{icon:t(()=>[a(s,{name:"edit"})]),default:t(()=>[f(" "+V(_.value?"":"编辑"),1)]),_:1},8,["onClick"]),a(i,{size:"small",variant:"outline",onClick:k=>Q(n)},{icon:t(()=>[a(s,{name:"file-copy"})]),default:t(()=>[f(" "+V(_.value?"":"复制"),1)]),_:1},8,["onClick"]),a(ee,{content:"确认删除此 API 密钥？",onConfirm:k=>O(n)},{default:t(()=>[a(i,{size:"small",theme:"danger"},{icon:t(()=>[a(s,{name:"delete"})]),default:t(()=>[f(" "+V(_.value?"":"删除"),1)]),_:1})]),_:1},8,["onConfirm"])]),_:2},1032,["size"])]),_:1},8,["data","pagination","empty"])]),_:1},8,["loading"])]),_:1}),a(ie,{visible:g.value,"onUpdate:visible":e[6]||(e[6]=n=>g.value=n),header:z.value,"confirm-btn":{content:h.value?"提交中...":"确定",loading:h.value},onConfirm:H,width:"500px"},{default:t(()=>[a(oe,{data:o.value,"label-width":"80px",rules:$,ref_key:"formRef",ref:L},{default:t(()=>[a(P,{label:"名称",name:"name",required:""},{default:t(()=>[a(v,{modelValue:o.value.name,"onUpdate:modelValue":e[3]||(e[3]=n=>o.value.name=n),placeholder:"请输入密钥名称，例如：生产环境 API",maxlength:"50"},null,8,["modelValue"])]),_:1}),a(P,{label:"权限",name:"permissions"},{default:t(()=>[a(x,{modelValue:o.value.permissions,"onUpdate:modelValue":e[4]||(e[4]=n=>o.value.permissions=n)},{default:t(()=>[a(r,{value:"read",label:"只读 - 仅查询数据"}),a(r,{value:"write",label:"读写 - 可修改数据"})]),_:1},8,["modelValue"])]),_:1}),o.value.id?T("",!0):(U(),N(P,{key:0,label:"有效期",name:"expiresIn"},{default:t(()=>[a(x,{modelValue:o.value.expiresIn,"onUpdate:modelValue":e[5]||(e[5]=n=>o.value.expiresIn=n)},{default:t(()=>[a(r,{value:"",label:"永不过期"}),a(r,{value:"30d",label:"30 天"}),a(r,{value:"90d",label:"90 天"}),a(r,{value:"1y",label:"1 年"})]),_:1},8,["modelValue"])]),_:1})),y.value?(U(),N(ne,{key:1,theme:"success",title:"密钥创建成功！",style:{"margin-top":"16px"}},{default:t(()=>[b("div",_e,[e[11]||(e[11]=b("p",{style:{margin:"0 0 8px 0","font-weight":"500"}},"请立即复制并妥善保存，此密钥仅显示一次：",-1)),a(se,{value:y.value,readonly:"",autosize:{minRows:2,maxRows:4},style:{"font-family":"monospace","font-size":"12px"}},null,8,["value"]),a(i,{size:"small",theme:"primary",variant:"outline",onClick:X,style:{"margin-top":"8px"}},{icon:t(()=>[a(s,{name:"file-copy"})]),default:t(()=>[e[10]||(e[10]=f(" 复制密钥 ",-1))]),_:1})])]),_:1})):T("",!0)]),_:1},8,["data"])]),_:1},8,["visible","header","confirm-btn"])])}}},he=re(fe,[["__scopeId","data-v-0d5e3a9b"]]);export{he as default};
