import{a as j}from"./index-DT9TBuYH.js";import{_ as ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as C,y as K,h as ue,M as D,c as P,a as n,b as e,w as t,d as c,o as h,f as d,t as i,l as R,m as I}from"./index-DNqqV_T_.js";const _e={class:"admin-logs"},pe={class:"page-header"},me={class:"stat-card"},fe={class:"stat-icon operation"},ge={class:"stat-info"},ve={class:"stat-value"},ye={class:"stat-card"},he={class:"stat-icon login"},be={class:"stat-info"},we={class:"stat-value"},Le={class:"stat-card"},xe={class:"stat-icon success"},ke={class:"stat-info"},Ve={class:"stat-value"},Ce={class:"stat-card"},Re={class:"stat-icon failed"},ze={class:"stat-info"},Se={class:"stat-value"},Ke={class:"filter-section"},De={key:0},Pe={key:0,class:"text-secondary"},Oe={key:1,class:"text-secondary"},Ue={class:"filter-section"},Ie={class:"ip-code"},Be={key:0,class:"log-detail"},Ne={class:"user-agent"},Te={class:"details-pre"},$e={__name:"Logs",setup(je){const V=C(!1),b=C("operation"),B=C([]),N=C([]),r=C(null),T=C(!1),u=K({username:"",action:"",dateRange:[]}),_=K({username:"",status:"",dateRange:[]}),w=K({current:1,pageSize:20,total:0}),L=K({current:1,pageSize:20,total:0}),x=K({todayOperations:0,todayLogins:0,successRate:0,failedLogins:0}),H=[{colKey:"username",title:"用户",width:120},{colKey:"action",title:"操作",width:150,cell:"action"},{colKey:"resource",title:"资源",width:150,cell:"resource"},{colKey:"status",title:"状态",width:80,cell:"status"},{colKey:"ip_address",title:"IP地址",width:140},{colKey:"created_at",title:"时间",width:180,cell:"created_at"},{colKey:"operation",title:"操作",width:80,fixed:"right",cell:"operation"}],J=[{colKey:"username",title:"用户名",width:120},{colKey:"login_type",title:"登录方式",width:100},{colKey:"status",title:"状态",width:80,cell:"status"},{colKey:"ip_address",title:"IP地址",width:140,cell:"ip_address"},{colKey:"failure_reason",title:"失败原因",width:150},{colKey:"created_at",title:"时间",width:180,cell:"created_at"},{colKey:"operation",title:"操作",width:80,fixed:"right",cell:"operation"}];ue(()=>{$(),W()});function Q(o){b.value=o,$()}async function $(){b.value==="operation"?await O():await U()}async function O(){V.value=!0;try{const o={page:w.current,pageSize:w.pageSize,username:u.username,action:u.action};u.dateRange&&u.dateRange.length===2&&(o.startDate=u.dateRange[0],o.endDate=u.dateRange[1]);const a=await j.getOperationLogs(o);a.data.success&&(B.value=a.data.data.logs,w.total=a.data.data.pagination.total)}catch(o){console.error("加载操作日志失败:",o),D.error("加载操作日志失败")}finally{V.value=!1}}async function U(){V.value=!0;try{const o={page:L.current,pageSize:L.pageSize,username:_.username,status:_.status};_.dateRange&&_.dateRange.length===2&&(o.startDate=_.dateRange[0],o.endDate=_.dateRange[1]);const a=await j.getLoginLogs(o);a.data.success&&(N.value=a.data.data.logs,L.total=a.data.data.pagination.total)}catch(o){console.error("加载登录日志失败:",o),D.error("加载登录日志失败")}finally{V.value=!1}}async function W(){var o,a,p,m,k;try{const g=await j.getEnhancedStatistics();if(g.data.success){const v=g.data.data;x.todayOperations=((o=v.activity)==null?void 0:o.todayOperations)||0,x.todayLogins=((a=v.users)==null?void 0:a.todayLogins)||0,x.failedLogins=((p=v.activity)==null?void 0:p.failedLogins)||0;const l=((m=v.activity)==null?void 0:m.weekLogins)||0,f=((k=v.activity)==null?void 0:k.failedLogins)||0;l>0&&(x.successRate=Math.round((l-f)/l*100))}}catch(g){console.error("加载统计数据失败:",g)}}function X(){w.current=1,O()}function Y(){L.current=1,U()}function Z(){u.username="",u.action="",u.dateRange=[],w.current=1,O()}function ee(){_.username="",_.status="",_.dateRange=[],L.current=1,U()}function te(o){w.current=o.current,w.pageSize=o.pageSize,O()}function ae(o){L.current=o.current,L.pageSize=o.pageSize,U()}function F(o){r.value=o,T.value=!0}async function se(){try{const o=b.value==="operation"?"操作日志":"登录日志",a=b.value==="operation"?B.value:N.value;if(a.length===0){D.warning("暂无数据可导出");return}const p=b.value==="operation"?["ID","用户名","操作","资源类型","资源ID","状态","IP地址","时间"]:["ID","用户名","登录方式","状态","IP地址","失败原因","时间"],m=a.map(l=>b.value==="operation"?[l.id,l.username||"",l.action||"",l.resource_type||"",l.resource_id||"",l.status||"",l.ip_address||"",z(l.created_at)]:[l.id,l.username||"",l.login_type||"",l.status||"",l.ip_address||"",l.failure_reason||"",z(l.created_at)]),k=[p.join(","),...m.map(l=>l.map(f=>`"${f}"`).join(","))].join(`
`),g=new Blob(["\uFEFF"+k],{type:"text/csv;charset=utf-8;"}),v=document.createElement("a");v.href=URL.createObjectURL(g),v.download=`${o}_${new Date().toISOString().split("T")[0]}.csv`,v.click(),D.success("日志导出成功")}catch(o){console.error("导出日志失败:",o),D.error("导出日志失败")}}function z(o){return o?new Date(o).toLocaleString("zh-CN"):"-"}return(o,a)=>{const p=c("t-icon"),m=c("t-button"),k=c("t-space"),g=c("t-col"),v=c("t-row"),l=c("t-input"),f=c("t-form-item"),M=c("t-date-range-picker"),E=c("t-form"),S=c("t-tag"),A=c("t-table"),q=c("t-tab-panel"),G=c("t-option"),oe=c("t-select"),ne=c("t-tabs"),le=c("t-card"),y=c("t-descriptions-item"),ie=c("t-descriptions"),de=c("t-dialog");return h(),P("div",_e,[n("div",pe,[a[10]||(a[10]=n("h3",null,"日志审计",-1)),e(k,null,{default:t(()=>[e(m,{theme:"default",onClick:$},{icon:t(()=>[e(p,{name:"refresh"})]),default:t(()=>[a[8]||(a[8]=d(" 刷新 ",-1))]),_:1}),e(m,{theme:"primary",onClick:se},{icon:t(()=>[e(p,{name:"download"})]),default:t(()=>[a[9]||(a[9]=d(" 导出日志 ",-1))]),_:1})]),_:1})]),e(v,{gutter:16,class:"stats-row"},{default:t(()=>[e(g,{xs:6,sm:3},{default:t(()=>[n("div",me,[n("div",fe,[e(p,{name:"edit",size:"24px"})]),n("div",ge,[n("div",ve,i(x.todayOperations||0),1),a[11]||(a[11]=n("div",{class:"stat-label"},"今日操作",-1))])])]),_:1}),e(g,{xs:6,sm:3},{default:t(()=>[n("div",ye,[n("div",he,[e(p,{name:"login",size:"24px"})]),n("div",be,[n("div",we,i(x.todayLogins||0),1),a[12]||(a[12]=n("div",{class:"stat-label"},"今日登录",-1))])])]),_:1}),e(g,{xs:6,sm:3},{default:t(()=>[n("div",Le,[n("div",xe,[e(p,{name:"check-circle",size:"24px"})]),n("div",ke,[n("div",Ve,i(x.successRate||0)+"%",1),a[13]||(a[13]=n("div",{class:"stat-label"},"成功率",-1))])])]),_:1}),e(g,{xs:6,sm:3},{default:t(()=>[n("div",Ce,[n("div",Re,[e(p,{name:"close-circle",size:"24px"})]),n("div",ze,[n("div",Se,i(x.failedLogins||0),1),a[14]||(a[14]=n("div",{class:"stat-label"},"失败登录",-1))])])]),_:1})]),_:1}),e(le,{class:"logs-card"},{default:t(()=>[e(ne,{modelValue:b.value,"onUpdate:modelValue":a[6]||(a[6]=s=>b.value=s),onChange:Q},{default:t(()=>[e(q,{value:"operation",label:"操作日志"},{default:t(()=>[n("div",Ke,[e(E,{data:u,layout:"inline"},{default:t(()=>[e(f,{label:"用户名"},{default:t(()=>[e(l,{modelValue:u.username,"onUpdate:modelValue":a[0]||(a[0]=s=>u.username=s),placeholder:"输入用户名",clearable:"",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),e(f,{label:"操作类型"},{default:t(()=>[e(l,{modelValue:u.action,"onUpdate:modelValue":a[1]||(a[1]=s=>u.action=s),placeholder:"输入操作",clearable:"",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),e(f,{label:"时间范围"},{default:t(()=>[e(M,{modelValue:u.dateRange,"onUpdate:modelValue":a[2]||(a[2]=s=>u.dateRange=s),clearable:"",style:{width:"280px"}},null,8,["modelValue"])]),_:1}),e(f,null,{default:t(()=>[e(k,null,{default:t(()=>[e(m,{theme:"primary",onClick:X},{icon:t(()=>[e(p,{name:"search"})]),default:t(()=>[a[15]||(a[15]=d(" 搜索 ",-1))]),_:1}),e(m,{onClick:Z},{default:t(()=>[...a[16]||(a[16]=[d("重置",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["data"])]),e(A,{data:B.value,columns:H,loading:V.value,pagination:w,onPageChange:te,"row-key":"id",bordered:"",stripe:"","max-height":"600px"},{action:t(({row:s})=>[e(S,{theme:"primary",variant:"light"},{default:t(()=>[d(i(s.action),1)]),_:2},1024)]),resource:t(({row:s})=>[s.resource_type?(h(),P("span",De,[d(i(s.resource_type)+" ",1),s.resource_id?(h(),P("span",Pe,"#"+i(s.resource_id),1)):R("",!0)])):(h(),P("span",Oe,"-"))]),status:t(({row:s})=>[e(S,{theme:s.status==="success"?"success":"danger"},{default:t(()=>[d(i(s.status==="success"?"成功":"失败"),1)]),_:2},1032,["theme"])]),created_at:t(({row:s})=>[d(i(z(s.created_at)),1)]),operation:t(({row:s})=>[e(m,{size:"small",variant:"text",theme:"primary",onClick:re=>F(s)},{default:t(()=>[...a[17]||(a[17]=[d(" 详情 ",-1)])]),_:1},8,["onClick"])]),_:1},8,["data","loading","pagination"])]),_:1}),e(q,{value:"login",label:"登录日志"},{default:t(()=>[n("div",Ue,[e(E,{data:_,layout:"inline"},{default:t(()=>[e(f,{label:"用户名"},{default:t(()=>[e(l,{modelValue:_.username,"onUpdate:modelValue":a[3]||(a[3]=s=>_.username=s),placeholder:"输入用户名",clearable:"",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),e(f,{label:"状态"},{default:t(()=>[e(oe,{modelValue:_.status,"onUpdate:modelValue":a[4]||(a[4]=s=>_.status=s),clearable:"",style:{width:"120px"}},{default:t(()=>[e(G,{value:"success",label:"成功"}),e(G,{value:"failed",label:"失败"})]),_:1},8,["modelValue"])]),_:1}),e(f,{label:"时间范围"},{default:t(()=>[e(M,{modelValue:_.dateRange,"onUpdate:modelValue":a[5]||(a[5]=s=>_.dateRange=s),clearable:"",style:{width:"280px"}},null,8,["modelValue"])]),_:1}),e(f,null,{default:t(()=>[e(k,null,{default:t(()=>[e(m,{theme:"primary",onClick:Y},{icon:t(()=>[e(p,{name:"search"})]),default:t(()=>[a[18]||(a[18]=d(" 搜索 ",-1))]),_:1}),e(m,{onClick:ee},{default:t(()=>[...a[19]||(a[19]=[d("重置",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["data"])]),e(A,{data:N.value,columns:J,loading:V.value,pagination:L,onPageChange:ae,"row-key":"id",bordered:"",stripe:"","max-height":"600px"},{status:t(({row:s})=>[e(S,{theme:s.status==="success"?"success":"danger"},{default:t(()=>[d(i(s.status==="success"?"成功":"失败"),1)]),_:2},1032,["theme"])]),ip_address:t(({row:s})=>[n("code",Ie,i(s.ip_address||"-"),1)]),created_at:t(({row:s})=>[d(i(z(s.created_at)),1)]),operation:t(({row:s})=>[e(m,{size:"small",variant:"text",theme:"primary",onClick:re=>F(s)},{default:t(()=>[...a[20]||(a[20]=[d(" 详情 ",-1)])]),_:1},8,["onClick"])]),_:1},8,["data","loading","pagination"])]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(de,{visible:T.value,"onUpdate:visible":a[7]||(a[7]=s=>T.value=s),header:"日志详情",width:"600px"},{default:t(()=>[r.value?(h(),P("div",Be,[e(ie,{bordered:""},{default:t(()=>[e(y,{label:"用户名"},{default:t(()=>[d(i(r.value.username||"-"),1)]),_:1}),e(y,{label:"操作/类型"},{default:t(()=>[d(i(r.value.action||r.value.login_type||"-"),1)]),_:1}),e(y,{label:"状态",span:"2"},{default:t(()=>[e(S,{theme:r.value.status==="success"?"success":"danger"},{default:t(()=>[d(i(r.value.status==="success"?"成功":"失败"),1)]),_:1},8,["theme"])]),_:1}),r.value.resource_type?(h(),I(y,{key:0,label:"资源类型"},{default:t(()=>[d(i(r.value.resource_type),1)]),_:1})):R("",!0),r.value.resource_id?(h(),I(y,{key:1,label:"资源ID"},{default:t(()=>[d(i(r.value.resource_id),1)]),_:1})):R("",!0),e(y,{label:"IP地址",span:r.value.resource_type?2:1},{default:t(()=>[n("code",null,i(r.value.ip_address||"-"),1)]),_:1},8,["span"]),e(y,{label:"User-Agent",span:"2"},{default:t(()=>[n("div",Ne,i(r.value.user_agent||"-"),1)]),_:1}),r.value.details?(h(),I(y,{key:2,label:"详细信息",span:"2"},{default:t(()=>[n("pre",Te,i(r.value.details),1)]),_:1})):R("",!0),r.value.failure_reason?(h(),I(y,{key:3,label:"失败原因",span:"2"},{default:t(()=>[e(S,{theme:"danger"},{default:t(()=>[d(i(r.value.failure_reason),1)]),_:1})]),_:1})):R("",!0),e(y,{label:"时间",span:"2"},{default:t(()=>[d(i(z(r.value.created_at)),1)]),_:1})]),_:1})])):R("",!0)]),_:1},8,["visible"])])}}},Ae=ce($e,[["__scopeId","data-v-0ac79160"]]);export{Ae as default};
