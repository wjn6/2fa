import{d as e}from"./index-42d0e3ec.js";import{_ as a}from"./_plugin-vue_export-helper-1b428a4d.js";import{M as l}from"./ui-703c31fd.js";import{r as t,o as i,j as s,c as n,w as r,O as o,P as u,Q as d,b as v,$ as m,Z as c,E as p,a3 as y,a1 as f,_ as w,a0 as _}from"./vendor-d600c78b.js";import"./utils-783a0963.js";import"./index-64ce2276.js";const g={class:"api-keys app-container"},h={class:"page-header"},x={class:"filters"},b={style:{"margin-top":"8px"}},k=a({__name:"ApiKeys",setup(a){const k=t([]),V=t(!1),z=t(""),C=t({id:null,name:"",permissions:"read",expiresIn:""}),I=t(null),S=t(""),K=t({keyword:"",permissions:"",status:""}),j=t({current:1,pageSize:10,total:0}),A=t(!1),P=t(!1),U=t(window.innerWidth<=768),L={name:[{required:!0,message:"请输入密钥名称",type:"error"},{min:2,message:"名称至少2个字符",type:"warning"}]},E=()=>{U.value=window.innerWidth<=768};i(()=>{window.addEventListener("resize",E)}),s(()=>{window.removeEventListener("resize",E)});const R=[{colKey:"name",title:"名称"},{colKey:"key_prefix",title:"前缀"},{colKey:"permissions",title:"权限",cell:"permissions"},{colKey:"is_active",title:"启用",cell:"is_active",width:120},{colKey:"expires_at",title:"到期时间",width:180},{colKey:"last_used_at",title:"最后使用",width:180},{colKey:"operation",title:"操作",width:200}],q=async()=>{var a,t;A.value=!0;try{const a=await e.list();k.value=a.data.data||[],j.value.total=T.value.length}catch(i){l.error((null==(t=null==(a=i.response)?void 0:a.data)?void 0:t.message)||"加载 API 密钥失败")}finally{A.value=!1}},T=n(()=>{const e=(K.value.keyword||"").toLowerCase();return(k.value||[]).filter(a=>{const l=!e||String(a.name||"").toLowerCase().includes(e)||String(a.key_prefix||"").toLowerCase().includes(e),t=!K.value.permissions||a.permissions===K.value.permissions,i=""===K.value.status||String(a.is_active)===String(K.value.status);return l&&t&&i})}),W=n(()=>{const e=(j.value.current-1)*j.value.pageSize;return T.value.slice(e,e+j.value.pageSize)});r(T,e=>{j.value.total=e.length,(j.value.current-1)*j.value.pageSize>=e.length&&(j.value.current=1)});const M=e=>{const{current:a,pageSize:l}=e;j.value.current=a,j.value.pageSize=l},O=()=>{K.value={keyword:"",permissions:"",status:""}},Q=()=>{z.value="新建密钥",C.value={id:null,name:"",permissions:"read",expiresIn:""},S.value="",V.value=!0},Z=async()=>{var a,t,i,s;if(await(null==(a=I.value)?void 0:a.validate())){P.value=!0;try{if(C.value.id)await e.update(C.value.id,{name:C.value.name,permissions:C.value.permissions}),l.success("更新成功"),V.value=!1;else{const a=await e.create({name:C.value.name,permissions:C.value.permissions,expiresIn:C.value.expiresIn});S.value=(null==(t=a.data.data)?void 0:t.apiKey)||"",l.success("创建成功，请立即保存密钥")}await q()}catch(n){l.error((null==(s=null==(i=n.response)?void 0:i.data)?void 0:s.message)||"操作失败，请重试")}finally{P.value=!1}}},$=async()=>{try{await navigator.clipboard.writeText(S.value),l.success("完整密钥已复制到剪贴板")}catch(e){l.error("复制失败，请手动复制")}};return i(()=>{q()}),(a,t)=>{const i=o("t-icon"),s=o("t-button"),n=o("t-input"),r=o("t-option"),E=o("t-select"),T=o("t-space"),B=o("t-tag"),D=o("t-switch"),F=o("t-popconfirm"),G=o("t-table"),H=o("t-loading"),J=o("t-card"),N=o("t-form-item"),X=o("t-textarea"),Y=o("t-alert"),ee=o("t-form"),ae=o("t-dialog");return u(),d("div",g,[v(J,{class:"app-card"},{default:m(()=>[c("div",h,[t[8]||(t[8]=c("h1",null,"API 密钥管理",-1)),v(s,{theme:"primary",onClick:Q},{icon:m(()=>[v(i,{name:"add"})]),default:m(()=>[t[7]||(t[7]=p(" 新建密钥 ",-1))]),_:1})]),c("div",x,[v(T,{direction:"vertical",style:{width:"100%"}},{default:m(()=>[v(T,{"break-line":U.value},{default:m(()=>[v(n,{modelValue:K.value.keyword,"onUpdate:modelValue":t[0]||(t[0]=e=>K.value.keyword=e),placeholder:"搜索名称或前缀",clearable:"",style:y({width:U.value?"100%":"220px"})},{"prefix-icon":m(()=>[v(i,{name:"search"})]),_:1},8,["modelValue","style"]),v(E,{modelValue:K.value.permissions,"onUpdate:modelValue":t[1]||(t[1]=e=>K.value.permissions=e),placeholder:"权限",clearable:"",style:y({width:U.value?"100%":"140px"})},{default:m(()=>[v(r,{value:"",label:"全部"}),v(r,{value:"read",label:"只读"}),v(r,{value:"write",label:"读写"})]),_:1},8,["modelValue","style"]),v(E,{modelValue:K.value.status,"onUpdate:modelValue":t[2]||(t[2]=e=>K.value.status=e),placeholder:"状态",clearable:"",style:y({width:U.value?"100%":"140px"})},{default:m(()=>[v(r,{value:"",label:"全部"}),v(r,{value:"1",label:"启用"}),v(r,{value:"0",label:"禁用"})]),_:1},8,["modelValue","style"]),v(s,{variant:"outline",onClick:O},{icon:m(()=>[v(i,{name:"refresh"})]),default:m(()=>[t[9]||(t[9]=p(" 重置 ",-1))]),_:1})]),_:1},8,["break-line"])]),_:1})]),v(H,{loading:A.value,size:"large"},{default:m(()=>[v(G,{data:W.value,columns:R,"row-key":"id",stripe:"",hover:"",pagination:j.value,onPageChange:M,empty:0===k.value.length?"暂无 API 密钥，点击上方按钮新建":"没有符合条件的数据"},{permissions:m(({row:e})=>[v(B,{theme:"primary",variant:"light-outline"},{default:m(()=>[p(f(e.permissions),1)]),_:2},1024)]),is_active:m(({row:a})=>[v(D,{value:1===a.is_active,onChange:t=>(async(a,t)=>{var i,s;try{await e.update(a.id,{isActive:t}),a.is_active=t?1:0,l.success(t?"已启用":"已禁用")}catch(n){l.error((null==(s=null==(i=n.response)?void 0:i.data)?void 0:s.message)||"操作失败"),a.is_active=t?0:1}})(a,t)},null,8,["value","onChange"])]),operation:m(({row:a})=>[v(T,{size:U.value?"small":"medium"},{default:m(()=>[v(s,{size:"small",onClick:e=>(e=>{z.value="编辑密钥",C.value={id:e.id,name:e.name,permissions:e.permissions,expiresIn:""},S.value="",V.value=!0})(a)},{icon:m(()=>[v(i,{name:"edit"})]),default:m(()=>[p(" "+f(U.value?"":"编辑"),1)]),_:1},8,["onClick"]),v(s,{size:"small",variant:"outline",onClick:e=>(async e=>{try{await navigator.clipboard.writeText(e.key_prefix||""),l.success("前缀已复制到剪贴板")}catch(a){l.error("复制失败，请手动复制")}})(a)},{icon:m(()=>[v(i,{name:"file-copy"})]),default:m(()=>[p(" "+f(U.value?"":"复制"),1)]),_:1},8,["onClick"]),v(F,{content:"确认删除此 API 密钥？",onConfirm:t=>(async a=>{var t,i;try{await e.delete(a.id),l.success("删除成功"),await q()}catch(s){l.error((null==(i=null==(t=s.response)?void 0:t.data)?void 0:i.message)||"删除失败")}})(a)},{default:m(()=>[v(s,{size:"small",theme:"danger"},{icon:m(()=>[v(i,{name:"delete"})]),default:m(()=>[p(" "+f(U.value?"":"删除"),1)]),_:1})]),_:1},8,["onConfirm"])]),_:2},1032,["size"])]),_:1},8,["data","pagination","empty"])]),_:1},8,["loading"])]),_:1}),v(ae,{visible:V.value,"onUpdate:visible":t[6]||(t[6]=e=>V.value=e),header:z.value,"confirm-btn":{content:P.value?"提交中...":"确定",loading:P.value},onConfirm:Z,width:"500px"},{default:m(()=>[v(ee,{data:C.value,"label-width":"80px",rules:L,ref_key:"formRef",ref:I},{default:m(()=>[v(N,{label:"名称",name:"name",required:""},{default:m(()=>[v(n,{modelValue:C.value.name,"onUpdate:modelValue":t[3]||(t[3]=e=>C.value.name=e),placeholder:"请输入密钥名称，例如：生产环境 API",maxlength:"50"},null,8,["modelValue"])]),_:1}),v(N,{label:"权限",name:"permissions"},{default:m(()=>[v(E,{modelValue:C.value.permissions,"onUpdate:modelValue":t[4]||(t[4]=e=>C.value.permissions=e)},{default:m(()=>[v(r,{value:"read",label:"只读 - 仅查询数据"}),v(r,{value:"write",label:"读写 - 可修改数据"})]),_:1},8,["modelValue"])]),_:1}),C.value.id?_("",!0):(u(),w(N,{key:0,label:"有效期",name:"expiresIn"},{default:m(()=>[v(E,{modelValue:C.value.expiresIn,"onUpdate:modelValue":t[5]||(t[5]=e=>C.value.expiresIn=e)},{default:m(()=>[v(r,{value:"",label:"永不过期"}),v(r,{value:"30d",label:"30 天"}),v(r,{value:"90d",label:"90 天"}),v(r,{value:"1y",label:"1 年"})]),_:1},8,["modelValue"])]),_:1})),S.value?(u(),w(Y,{key:1,theme:"success",title:"密钥创建成功！",style:{"margin-top":"16px"}},{default:m(()=>[c("div",b,[t[11]||(t[11]=c("p",{style:{margin:"0 0 8px 0","font-weight":"500"}},"请立即复制并妥善保存，此密钥仅显示一次：",-1)),v(X,{value:S.value,readonly:"",autosize:{minRows:2,maxRows:4},style:{"font-family":"monospace","font-size":"12px"}},null,8,["value"]),v(s,{size:"small",theme:"primary",variant:"outline",onClick:$,style:{"margin-top":"8px"}},{icon:m(()=>[v(i,{name:"file-copy"})]),default:m(()=>[t[10]||(t[10]=p(" 复制密钥 ",-1))]),_:1})])]),_:1})):_("",!0)]),_:1},8,["data"])]),_:1},8,["visible","header","confirm-btn"])])}}},[["__scopeId","data-v-5f564379"]]);export{k as default};
