import{a as f}from"./index-DT9TBuYH.js";import{_ as _e}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as v,y as G,h as ve,M as r,c as Q,a as l,b as t,w as o,d as u,o as $,m as W,l as T,t as p,f as d}from"./index-DNqqV_T_.js";const ge={class:"admin-system"},ye={class:"info-item"},be={class:"info-value"},we={class:"info-item"},ke={class:"info-value"},xe={class:"info-item"},Se={class:"info-value"},Ve={class:"info-item"},Ce={class:"info-value"},he={class:"info-item"},Ue={class:"info-value"},Be={class:"info-item"},Le={class:"info-value"},Me={class:"info-item"},Ie={class:"info-value"},Oe={class:"info-item"},$e={class:"info-value"},je={class:"migration-section"},ze={class:"migration-section"},De={key:0,class:"file-name"},Ne={class:"maintenance-item"},Re={class:"maintenance-item"},Te={class:"maintenance-item"},Ke={__name:"System",setup(Ae){const j=v(!1),z=v(!1),D=v(!1),V=v(!1),L=v(!1),g=v(null),K=v([]),M=v(!1),w=v(""),h=v("merge"),k=v(null),c=G({max_login_attempts:5,login_lockout_duration:30,session_timeout:24,password_min_length:6}),x=G({type:"all",days:90}),Z=[{colKey:"filename",title:"文件名",width:300},{colKey:"file_size",title:"大小",width:120,cell:"file_size"},{colKey:"backup_type",title:"类型",width:100,cell:"backup_type"},{colKey:"status",title:"状态",width:100,cell:"status"},{colKey:"creator_name",title:"创建者",width:120},{colKey:"created_at",title:"创建时间",width:180,cell:"created_at"},{colKey:"operation",title:"操作",width:150,fixed:"right",cell:"operation"}];ve(()=>{N(),I(),A()});async function N(){try{const a=await f.getSystemInfo();a.data.success&&(g.value=a.data.data)}catch(a){console.error("加载系统信息失败:",a)}}async function I(){j.value=!0;try{const a=await f.getBackups();a.data.success&&(K.value=a.data.data)}catch(a){console.error("加载备份列表失败:",a),r.error("加载备份列表失败")}finally{j.value=!1}}async function q(){z.value=!0;try{(await f.createBackup()).data.success&&(r.success("备份创建成功"),I())}catch(a){console.error("创建备份失败:",a),r.error("创建备份失败")}finally{z.value=!1}}async function H(a){try{const e=await f.downloadBackup(a),i=window.URL.createObjectURL(new Blob([e.data])),n=document.createElement("a");n.href=i,n.setAttribute("download",`backup-${a}.db`),document.body.appendChild(n),n.click(),n.remove(),r.success("下载成功")}catch(e){console.error("下载备份失败:",e),r.error("下载备份失败")}}async function X(a){try{(await f.deleteBackup(a)).data.success&&(r.success("删除成功"),I())}catch(e){console.error("删除备份失败:",e),r.error("删除备份失败")}}async function Y(){try{const a=await f.cleanupSessions();a.data.success&&r.success(a.data.message)}catch(a){console.error("清理会话失败:",a),r.error("清理会话失败")}}function ee(){x.type="all",x.days=90,M.value=!0}async function te(){try{const a=await f.cleanupLogs(x);a.data.success&&(r.success(a.data.message),M.value=!1)}catch(a){console.error("清理日志失败:",a),r.error("清理日志失败")}}async function ae(){try{const a=await f.optimizeDatabase();a.data.success&&r.success(a.data.message)}catch(a){console.error("优化数据库失败:",a),r.error("优化数据库失败")}}async function oe(){V.value=!0;try{const a=await f.exportAllData(),e=new Blob([JSON.stringify(a.data,null,2)],{type:"application/json"}),i=URL.createObjectURL(e),n=document.createElement("a");n.href=i,n.download=`2fa-export-all-${new Date().toISOString().split("T")[0]}.json`,n.click(),URL.revokeObjectURL(i),r.success("数据导出成功")}catch(a){console.error("导出数据失败:",a),r.error("导出数据失败")}finally{V.value=!1}}async function le(){if(w.value){V.value=!0;try{const a=await f.exportTable(w.value),e=new Blob([JSON.stringify(a.data,null,2)],{type:"application/json"}),i=URL.createObjectURL(e),n=document.createElement("a");n.href=i,n.download=`2fa-export-${w.value}-${new Date().toISOString().split("T")[0]}.json`,n.click(),URL.revokeObjectURL(i),r.success(`${w.value} 表数据导出成功`)}catch(a){console.error("导出表数据失败:",a),r.error("导出表数据失败")}finally{V.value=!1}}}function ne(a){const e=a.target.files[0];if(e){if(e.type!=="application/json"&&!e.name.endsWith(".json")){r.warning("请选择JSON文件");return}k.value=e}}async function se(){if(k.value)try{const a=new FileReader;a.onload=async e=>{try{const i=JSON.parse(e.target.result);if(!await new Promise(y=>{var U,_;const C=r.warning({content:h.value==="replace"?"警告：替换模式将清空现有数据（保留admin用户），确定要继续吗？":`确定要导入数据吗？导入 ${((U=i.statistics)==null?void 0:U.totalSecrets)||0} 个密钥和 ${((_=i.statistics)==null?void 0:_.totalUsers)||0} 个用户。`,duration:0,closeBtn:!0,onClose:()=>y(!1)});setTimeout(()=>y(!0),100)}))return;L.value=!0;const m=await f.importAllData(i,h.value);m.data.success&&(r.success("数据导入成功："+JSON.stringify(m.data.data)),k.value=null,N())}catch(i){console.error("解析JSON失败:",i),r.error("导入文件格式错误")}finally{L.value=!1}},a.onerror=()=>{r.error("文件读取失败")},a.readAsText(k.value)}catch(a){console.error("导入数据失败:",a),r.error("导入数据失败"),L.value=!1}}async function A(){var a,e,i,n;try{const m=await f.getSystemSettings();if(m.data.success){const y=m.data.data;c.max_login_attempts=parseInt(((a=y.max_login_attempts)==null?void 0:a.value)||5),c.login_lockout_duration=parseInt(((e=y.login_lockout_duration)==null?void 0:e.value)||30),c.session_timeout=parseInt(((i=y.session_timeout)==null?void 0:i.value)||24),c.password_min_length=parseInt(((n=y.password_min_length)==null?void 0:n.value)||6)}}catch(m){console.error("加载设置失败:",m)}}async function ie(){D.value=!0;try{(await f.updateSystemSettings({max_login_attempts:c.max_login_attempts.toString(),login_lockout_duration:c.login_lockout_duration.toString(),session_timeout:c.session_timeout.toString(),password_min_length:c.password_min_length.toString()})).data.success&&r.success("配置保存成功")}catch(a){console.error("保存配置失败:",a),r.error("保存配置失败")}finally{D.value=!1}}function O(a){if(!a)return"0 B";const e=1024,i=["B","KB","MB","GB"],n=Math.floor(Math.log(a)/Math.log(e));return Math.round(a/Math.pow(e,n)*100)/100+" "+i[n]}function re(a){const e=Math.floor(a/86400),i=Math.floor(a%86400/3600),n=Math.floor(a%3600/60);return`${e}天 ${i}小时 ${n}分钟`}function ue(a){return a?new Date(a).toLocaleString("zh-CN"):"-"}return(a,e)=>{const i=u("t-icon"),n=u("t-button"),m=u("t-col"),y=u("t-row"),C=u("t-card"),U=u("t-alert"),_=u("t-option"),E=u("t-select"),b=u("t-space"),R=u("t-divider"),F=u("t-radio"),de=u("t-radio-group"),J=u("t-tag"),ce=u("t-popconfirm"),me=u("t-table"),B=u("t-input-number"),S=u("t-form-item"),P=u("t-form"),fe=u("t-dialog");return $(),Q("div",ge,[e[39]||(e[39]=l("div",{class:"page-header"},[l("h3",null,"系统管理")],-1)),t(C,{title:"系统信息",class:"info-card"},{actions:o(()=>[t(n,{size:"small",variant:"text",onClick:N},{default:o(()=>[t(i,{name:"refresh"})]),_:1})]),default:o(()=>[g.value?($(),W(y,{key:0,gutter:16},{default:o(()=>[t(m,{xs:12,sm:6},{default:o(()=>[l("div",ye,[e[10]||(e[10]=l("div",{class:"info-label"},"操作系统",-1)),l("div",be,p(g.value.platform),1)])]),_:1}),t(m,{xs:12,sm:6},{default:o(()=>[l("div",we,[e[11]||(e[11]=l("div",{class:"info-label"},"架构",-1)),l("div",ke,p(g.value.arch),1)])]),_:1}),t(m,{xs:12,sm:6},{default:o(()=>[l("div",xe,[e[12]||(e[12]=l("div",{class:"info-label"},"Node版本",-1)),l("div",Se,p(g.value.nodeVersion),1)])]),_:1}),t(m,{xs:12,sm:6},{default:o(()=>[l("div",Ve,[e[13]||(e[13]=l("div",{class:"info-label"},"运行时长",-1)),l("div",Ce,p(re(g.value.uptime)),1)])]),_:1}),t(m,{xs:12,sm:6},{default:o(()=>[l("div",he,[e[14]||(e[14]=l("div",{class:"info-label"},"总内存",-1)),l("div",Ue,p(O(g.value.totalMemory)),1)])]),_:1}),t(m,{xs:12,sm:6},{default:o(()=>[l("div",Be,[e[15]||(e[15]=l("div",{class:"info-label"},"可用内存",-1)),l("div",Le,p(O(g.value.freeMemory)),1)])]),_:1}),t(m,{xs:12,sm:6},{default:o(()=>[l("div",Me,[e[16]||(e[16]=l("div",{class:"info-label"},"数据库大小",-1)),l("div",Ie,p(O(g.value.databaseSize)),1)])]),_:1}),t(m,{xs:12,sm:6},{default:o(()=>[l("div",Oe,[e[17]||(e[17]=l("div",{class:"info-label"},"CPU核心数",-1)),l("div",$e,p(g.value.cpus),1)])]),_:1})]),_:1})):T("",!0)]),_:1}),t(C,{title:"数据迁移",class:"migration-card"},{default:o(()=>[t(U,{theme:"info",message:"支持导出所有数据（用户、密钥、配置等）进行完整迁移",style:{"margin-bottom":"16px"}}),t(b,{direction:"vertical",style:{width:"100%"}},{default:o(()=>[l("div",je,[e[20]||(e[20]=l("h4",null,"导出数据",-1)),t(b,null,{default:o(()=>[t(n,{theme:"primary",onClick:oe,loading:V.value},{icon:o(()=>[t(i,{name:"download"})]),default:o(()=>[e[18]||(e[18]=d(" 导出完整数据 ",-1))]),_:1},8,["loading"]),t(E,{modelValue:w.value,"onUpdate:modelValue":e[0]||(e[0]=s=>w.value=s),placeholder:"选择表",style:{width:"200px"}},{default:o(()=>[t(_,{value:"users",label:"用户表"}),t(_,{value:"secrets",label:"密钥表"}),t(_,{value:"categories",label:"分类表"}),t(_,{value:"tags",label:"标签表"}),t(_,{value:"invite_codes",label:"邀请码表"}),t(_,{value:"system_settings",label:"系统配置"})]),_:1},8,["modelValue"]),t(n,{onClick:le,disabled:!w.value,loading:V.value},{icon:o(()=>[t(i,{name:"download"})]),default:o(()=>[e[19]||(e[19]=d(" 导出单表 ",-1))]),_:1},8,["disabled","loading"])]),_:1})]),t(R),l("div",ze,[e[25]||(e[25]=l("h4",null,"导入数据",-1)),t(b,{direction:"vertical",style:{width:"100%"}},{default:o(()=>[t(de,{modelValue:h.value,"onUpdate:modelValue":e[1]||(e[1]=s=>h.value=s)},{default:o(()=>[t(F,{value:"merge"},{default:o(()=>[...e[21]||(e[21]=[d("合并模式（保留现有数据，仅添加新数据）",-1)])]),_:1}),t(F,{value:"replace"},{default:o(()=>[...e[22]||(e[22]=[d("替换模式（清空现有数据，完全替换）",-1)])]),_:1})]),_:1},8,["modelValue"]),h.value==="replace"?($(),W(U,{key:0,theme:"warning",message:"警告：替换模式将清空现有数据（保留admin用户），请谨慎操作！"})):T("",!0),t(b,null,{default:o(()=>[t(n,{onClick:e[2]||(e[2]=s=>a.$refs.importFileInput.click())},{icon:o(()=>[t(i,{name:"upload"})]),default:o(()=>[e[23]||(e[23]=d(" 选择导入文件 ",-1))]),_:1}),k.value?($(),Q("span",De,p(k.value.name),1)):T("",!0),t(n,{theme:"primary",onClick:se,disabled:!k.value,loading:L.value},{icon:o(()=>[t(i,{name:"check"})]),default:o(()=>[e[24]||(e[24]=d(" 开始导入 ",-1))]),_:1},8,["disabled","loading"])]),_:1}),l("input",{ref:"importFileInput",type:"file",accept:".json",style:{display:"none"},onChange:ne},null,544)]),_:1})])]),_:1})]),_:1}),t(C,{title:"SQLite备份",class:"backup-card"},{actions:o(()=>[t(b,null,{default:o(()=>[t(n,{theme:"primary",onClick:q,loading:z.value},{icon:o(()=>[t(i,{name:"cloud-upload"})]),default:o(()=>[e[26]||(e[26]=d(" 创建备份 ",-1))]),_:1},8,["loading"]),t(n,{onClick:I},{icon:o(()=>[t(i,{name:"refresh"})]),default:o(()=>[e[27]||(e[27]=d(" 刷新 ",-1))]),_:1})]),_:1})]),default:o(()=>[t(me,{data:K.value,columns:Z,loading:j.value,"row-key":"id",bordered:"",stripe:""},{file_size:o(({row:s})=>[d(p(O(s.file_size)),1)]),backup_type:o(({row:s})=>[t(J,{theme:s.backup_type==="manual"?"primary":"success"},{default:o(()=>[d(p(s.backup_type==="manual"?"手动":"自动"),1)]),_:2},1032,["theme"])]),status:o(({row:s})=>[t(J,{theme:s.status==="completed"?"success":"warning"},{default:o(()=>[d(p(s.status==="completed"?"完成":"处理中"),1)]),_:2},1032,["theme"])]),created_at:o(({row:s})=>[d(p(ue(s.created_at)),1)]),operation:o(({row:s})=>[t(b,null,{default:o(()=>[t(n,{size:"small",variant:"text",theme:"primary",onClick:pe=>H(s.id)},{default:o(()=>[t(i,{name:"download"}),e[28]||(e[28]=d(" 下载 ",-1))]),_:1},8,["onClick"]),t(ce,{content:"确定要删除这个备份吗？",onConfirm:pe=>X(s.id)},{default:o(()=>[t(n,{size:"small",variant:"text",theme:"danger"},{default:o(()=>[...e[29]||(e[29]=[d(" 删除 ",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:2},1024)]),_:1},8,["data","loading"])]),_:1}),t(C,{title:"系统维护",class:"maintenance-card"},{default:o(()=>[t(b,{direction:"vertical",style:{width:"100%"}},{default:o(()=>[l("div",Ne,[e[31]||(e[31]=l("div",{class:"maintenance-info"},[l("h4",null,"清理过期会话"),l("p",null,"清理已过期的用户会话记录")],-1)),t(n,{onClick:Y},{default:o(()=>[...e[30]||(e[30]=[d(" 执行清理 ",-1)])]),_:1})]),t(R),l("div",Re,[e[33]||(e[33]=l("div",{class:"maintenance-info"},[l("h4",null,"清理日志"),l("p",null,"清理超过90天的操作日志和登录日志")],-1)),t(n,{onClick:ee},{default:o(()=>[...e[32]||(e[32]=[d(" 执行清理 ",-1)])]),_:1})]),t(R),l("div",Te,[e[35]||(e[35]=l("div",{class:"maintenance-info"},[l("h4",null,"优化数据库"),l("p",null,"执行数据库VACUUM和OPTIMIZE操作")],-1)),t(n,{onClick:ae},{default:o(()=>[...e[34]||(e[34]=[d(" 执行优化 ",-1)])]),_:1})])]),_:1})]),_:1}),t(C,{title:"安全配置",class:"config-card"},{default:o(()=>[t(P,{data:c,onSubmit:ie,"label-width":"180px"},{default:o(()=>[t(S,{label:"最大登录尝试次数"},{default:o(()=>[t(B,{modelValue:c.max_login_attempts,"onUpdate:modelValue":e[3]||(e[3]=s=>c.max_login_attempts=s),min:3,max:10},null,8,["modelValue"])]),_:1}),t(S,{label:"登录锁定时长（分钟）"},{default:o(()=>[t(B,{modelValue:c.login_lockout_duration,"onUpdate:modelValue":e[4]||(e[4]=s=>c.login_lockout_duration=s),min:5,max:120},null,8,["modelValue"])]),_:1}),t(S,{label:"会话超时时间（小时）"},{default:o(()=>[t(B,{modelValue:c.session_timeout,"onUpdate:modelValue":e[5]||(e[5]=s=>c.session_timeout=s),min:1,max:168},null,8,["modelValue"])]),_:1}),t(S,{label:"密码最小长度"},{default:o(()=>[t(B,{modelValue:c.password_min_length,"onUpdate:modelValue":e[6]||(e[6]=s=>c.password_min_length=s),min:6,max:20},null,8,["modelValue"])]),_:1}),t(S,null,{default:o(()=>[t(b,null,{default:o(()=>[t(n,{theme:"primary",type:"submit",loading:D.value},{default:o(()=>[...e[36]||(e[36]=[d(" 保存配置 ",-1)])]),_:1},8,["loading"]),t(n,{onClick:A},{default:o(()=>[...e[37]||(e[37]=[d(" 重置 ",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["data"])]),_:1}),t(fe,{visible:M.value,"onUpdate:visible":e[9]||(e[9]=s=>M.value=s),header:"清理日志",onConfirm:te},{default:o(()=>[t(P,{"label-width":"120px"},{default:o(()=>[t(S,{label:"日志类型"},{default:o(()=>[t(E,{modelValue:x.type,"onUpdate:modelValue":e[7]||(e[7]=s=>x.type=s)},{default:o(()=>[t(_,{value:"all",label:"所有日志"}),t(_,{value:"operation",label:"操作日志"}),t(_,{value:"login",label:"登录日志"})]),_:1},8,["modelValue"])]),_:1}),t(S,{label:"保留天数"},{default:o(()=>[t(B,{modelValue:x.days,"onUpdate:modelValue":e[8]||(e[8]=s=>x.days=s),min:7,max:365},null,8,["modelValue"]),e[38]||(e[38]=l("div",{class:"form-tip"},"将删除超过指定天数的日志",-1))]),_:1})]),_:1})]),_:1},8,["visible"])])}}},Pe=_e(Ke,[["__scopeId","data-v-31e8b87e"]]);export{Pe as default};
