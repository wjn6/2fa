# 🏗️ 系统架构说明

## 单容器架构 (v3.0+)

### 设计理念
- **简化部署**：一个容器包含所有组件
- **降低复杂度**：无需配置容器间网络
- **提升稳定性**：减少网络通信故障点

### 架构图
```
┌─────────────────────────────────────────┐
│         Docker Container (2fa-app)      │
│                                         │
│  ┌────────────────────────────────┐    │
│  │         Nginx :80              │    │
│  │  ┌──────────┐   ┌──────────┐  │    │
│  │  │  静态文件  │   │   API    │  │    │
│  │  │  /       │   │  /api/*  │  │    │
│  │  └──────────┘   └─────┬────┘  │    │
│  └───────────────────────┼────────┘    │
│                          │             │
│                          ↓             │
│              ┌───────────────────┐     │
│              │   Node.js :3000   │     │
│              │   (后端服务)       │     │
│              └─────────┬─────────┘     │
│                        │               │
│                        ↓               │
│              ┌───────────────────┐     │
│              │   SQLite Database │     │
│              │   (data目录)       │     │
│              └───────────────────┘     │
│                                         │
└─────────────────────────────────────────┘
         ↑
         │ :5656 (宿主机端口)
         │
    用户访问
```

### 组件说明

#### 1. Nginx (前端服务器)
- **端口**: 80 (容器内)
- **功能**:
  - 服务静态文件 (Vue.js 编译后的 dist/)
  - 反向代理 API 请求到 Node.js
  - 处理路由重定向

#### 2. Node.js (后端服务)
- **端口**: 3000 (容器内，不对外暴露)
- **功能**:
  - RESTful API 服务
  - JWT 认证
  - 业务逻辑处理
  - 数据库操作

#### 3. SQLite (数据库)
- **路径**: `/app/backend/data/database.db`
- **挂载**: 宿主机 `./data` 目录
- **功能**:
  - 用户数据存储
  - 密钥管理
  - 系统配置

### 文件结构
```
2fa/
├── Dockerfile              # 单容器构建文件
├── docker-compose.yml      # 编排配置
├── nginx.conf             # Nginx 配置
├── start.sh               # 启动脚本
├── backend/               # 后端源码
│   ├── src/
│   ├── package.json
│   └── data/              # 数据目录（挂载点）
└── frontend/              # 前端编译产物
    └── dist/              # 静态文件
```

### 启动流程
1. `docker-compose up -d`
2. 读取 `Dockerfile` 构建镜像
3. 执行 `start.sh` 启动脚本
4. 启动 Node.js 后端 (端口 3000)
5. 启动 Nginx (端口 80)
6. Nginx 反向代理 API 到 Node.js
7. 容器就绪，对外暴露 5656 端口

### 请求流程

#### 前端页面请求
```
浏览器 → :5656 → Nginx :80 → /usr/share/nginx/html/index.html
```

#### API 请求
```
浏览器 → :5656/api/* → Nginx :80 → 反向代理 → Node.js :3000/api/*
```

### 优势对比

| 特性 | 单容器 | 多容器 |
|-----|-------|-------|
| 部署复杂度 | ⭐ 简单 | ⭐⭐⭐ 复杂 |
| 网络配置 | 无需配置 | 需要 Docker 网络 |
| 故障点 | 1个 | 2个 + 网络 |
| 资源占用 | 低 | 中等 |
| 启动速度 | 快 | 较慢 |
| 维护成本 | 低 | 高 |
| 扩展性 | 适合中小型 | 适合大型 |

### 端口映射
- **宿主机**: 5656
- **容器**: 80 (Nginx)
- **内部**: 3000 (Node.js，不对外)

### 数据持久化
```yaml
volumes:
  - ./data:/app/backend/data
```
- 数据库文件: `data/database.db`
- 备份文件: `data/backups/`
- 日志文件: 容器内（可通过 docker logs 查看）

### 性能优化
1. **前端**: 预编译，无需运行时构建
2. **后端**: 生产模式，移除开发依赖
3. **Nginx**: 静态资源缓存
4. **SQLite**: WAL 模式，提升并发

### 安全特性
- ✅ Node.js 仅监听 127.0.0.1:3000，不对外暴露
- ✅ Nginx 作为唯一入口点
- ✅ 数据目录权限控制
- ✅ 健康检查机制

### 升级迁移
```bash
# 从多容器版本迁移到单容器
1. 停止旧容器: docker-compose down
2. 备份数据: cp -r data data.backup
3. 拉取最新代码: git pull
4. 启动新版本: docker-compose up -d --build
```

### 故障排查
```bash
# 查看容器状态
docker ps

# 查看完整日志
docker logs 2fa-app

# 进入容器调试
docker exec -it 2fa-app sh

# 检查 Nginx 配置
docker exec 2fa-app nginx -t

# 检查进程
docker exec 2fa-app ps aux
```

## 技术栈
- **前端**: Vue 3 + TDesign + Vite
- **后端**: Node.js + Express
- **数据库**: SQLite3
- **Web服务器**: Nginx
- **容器**: Docker + Alpine Linux

## 版本历史
- **v3.0**: 单容器架构（当前版本）
- **v2.9**: 多容器架构（前后端分离）
- **v1.0**: 单体应用

---

**推荐用于**: 个人使用、小团队、中小型企业  
**并发支持**: 100+ 用户同时在线  
**资源需求**: 512MB RAM + 1GB 磁盘

